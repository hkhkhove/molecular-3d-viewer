<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Molecular 3D Viewer - Learn WGPU</title>
        <style>
            body {
                margin: 0;
                padding: 20px;
                background-color: #1e1e1e;
                color: white;
                font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            }

            .container {
                max-width: 1200px;
                margin: 0 auto;
            }

            .header {
                text-align: center;
                margin-bottom: 20px;
            }

            .header h1 {
                color: #61dafb;
                margin: 0;
            }

            .header p {
                color: #aaa;
                margin: 10px 0;
            }

            .viewer-container {
                border: 2px solid #333;
                border-radius: 8px;
                overflow: hidden;
                background: #000;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            }

            canvas {
                display: block;
                width: 100%;
                height: 600px;
            }

            .controls {
                margin-top: 20px;
                padding: 15px;
                background: #2d2d2d;
                border-radius: 8px;
                text-align: center;
            }

            .controls p {
                margin: 5px 0;
                color: #ccc;
            }

            .error {
                color: #ff6b6b;
                background: #4a1a1a;
                padding: 15px;
                border-radius: 8px;
                margin: 20px 0;
                border: 1px solid #ff6b6b;
            }

            .loading {
                color: #ffd93d;
                text-align: center;
                padding: 20px;
            }

            .status {
                color: #6bcf7f;
                text-align: center;
                padding: 10px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>ğŸ§¬ Molecular 3D Viewer</h1>
                <p>A personal WGPU learning project for visualizing protein structures</p>
            </div>

            <div id="loading" class="loading">Loading WASM module and initializing 3D viewer...</div>

            <div id="error" class="error" style="display: none">
                <h3>Error loading the viewer</h3>
                <p id="error-message"></p>
                <p>Please make sure your browser supports WebGL and WebAssembly.</p>
            </div>

            <div class="viewer-container" id="viewer-container" style="display: none">
                <canvas id="wgpu-canvas"></canvas>
            </div>

            <div class="controls" id="controls" style="display: none">
                <div style="margin-bottom: 20px">
                    <h3>ğŸ§¬ åŠ è½½è›‹ç™½è´¨æ–‡ä»¶</h3>
                    <div style="margin: 10px 0">
                        <label for="file-input">é€‰æ‹©PDBæ–‡ä»¶:</label>
                        <input type="file" id="file-input" accept=".pdb" style="margin-left: 10px" />
                    </div>
                    <div style="margin: 10px 0">
                        <label for="url-input">æˆ–è¾“å…¥URL:</label>
                        <input type="text" id="url-input" placeholder="http://localhost:8000/8w2s.pdb" style="margin-left: 10px; width: 300px" />
                        <button id="load-url-btn" style="margin-left: 10px">åŠ è½½</button>
                    </div>
                </div>

                <div style="border-top: 1px solid #444; padding-top: 15px">
                    <p><strong>æ§åˆ¶è¯´æ˜:</strong></p>
                    <p>ğŸ–±ï¸ é¼ æ ‡æ‹–æ‹½: æ—‹è½¬è§†è§’</p>
                    <p>âŒ¨ï¸ WASD: ç§»åŠ¨ç›¸æœº</p>
                    <p>ğŸ”„ ç©ºæ ¼: åˆ‡æ¢æ¸²æŸ“æ¨¡å¼</p>
                    <p>ğŸ“· Q/E: ç¼©æ”¾</p>
                </div>
            </div>

            <div id="status" class="status" style="display: none"></div>
        </div>

        <script type="module">
            import init, { run_app, load_protein_from_file, load_protein_from_url, load_protein_from_blob } from "./pkg/learn_wgpu.js";

            // Store WASM functions globally
            let wasmFunctions = null;

            async function loadViewer() {
                try {
                    console.log("å¼€å§‹åŠ è½½WASMæ¨¡å—...");

                    // Initialize the WASM module
                    await init();
                    console.log("WASMæ¨¡å—åˆå§‹åŒ–æˆåŠŸ");

                    // Store functions globally for easy access
                    wasmFunctions = {
                        run_app,
                        load_protein_from_file,
                        load_protein_from_url,
                        load_protein_from_blob,
                    };

                    // Show the canvas
                    document.getElementById("loading").style.display = "none";
                    document.getElementById("viewer-container").style.display = "block";
                    document.getElementById("controls").style.display = "block";

                    // Get the canvas element
                    const canvas = document.getElementById("wgpu-canvas");
                    console.log("Canvaså…ƒç´ è·å–æˆåŠŸ:", canvas);

                    // Set canvas size
                    canvas.width = canvas.offsetWidth;
                    canvas.height = canvas.offsetHeight;
                    console.log("Canvaså°ºå¯¸è®¾ç½®:", canvas.width, "x", canvas.height);

                    // Check WebGL support
                    const gl = canvas.getContext("webgl2") || canvas.getContext("webgl");
                    if (!gl) {
                        throw new Error("WebGL is not supported in this browser");
                    }
                    console.log("WebGLæ”¯æŒæ£€æŸ¥é€šè¿‡");

                    // Start the application
                    console.log("å¼€å§‹å¯åŠ¨åº”ç”¨...");
                    try {
                        run_app();
                        console.log("åº”ç”¨å¯åŠ¨æˆåŠŸ");
                    } catch (appError) {
                        console.error("åº”ç”¨å¯åŠ¨å¤±è´¥:", appError);
                        throw appError;
                    }

                    // Setup file handlers
                    setupFileHandlers();

                    document.getElementById("status").innerHTML = "3D Viewer loaded successfully!";
                    document.getElementById("status").style.display = "block";
                } catch (error) {
                    console.error("è¯¦ç»†é”™è¯¯ä¿¡æ¯:", error);
                    console.error("é”™è¯¯å †æ ˆ:", error.stack);
                    document.getElementById("loading").style.display = "none";
                    document.getElementById("error").style.display = "block";
                    document.getElementById("error-message").innerHTML = `
                    <strong>é”™è¯¯ç±»å‹:</strong> ${error.name || "Unknown"}<br>
                    <strong>é”™è¯¯ä¿¡æ¯:</strong> ${error.message || error.toString()}<br>
                    <strong>é”™è¯¯è¯¦æƒ…:</strong> è¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°è·å–æ›´å¤šä¿¡æ¯
                `;
                }
            }

            function setupFileHandlers() {
                // File input handler
                const fileInput = document.getElementById("file-input");
                fileInput.addEventListener("change", async (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        try {
                            console.log("Loading file:", file.name);
                            document.getElementById("status").innerHTML = `æ­£åœ¨åŠ è½½æ–‡ä»¶: ${file.name}...`;
                            await load_protein_from_file(file);
                            document.getElementById("status").innerHTML = `æˆåŠŸåŠ è½½æ–‡ä»¶: ${file.name}`;
                        } catch (error) {
                            console.error("Failed to load file:", error);
                            document.getElementById("error-message").textContent = `åŠ è½½æ–‡ä»¶å¤±è´¥: ${error}`;
                            document.getElementById("error").style.display = "block";
                        }
                    }
                });

                // URL input handler
                const urlInput = document.getElementById("url-input");
                const loadUrlBtn = document.getElementById("load-url-btn");

                const loadFromUrl = async () => {
                    const url = urlInput.value.trim();
                    if (url) {
                        try {
                            console.log("Loading from URL:", url);
                            document.getElementById("status").innerHTML = `æ­£åœ¨ä»URLåŠ è½½: ${url}...`;
                            await load_protein_from_url(url);
                            document.getElementById("status").innerHTML = `æˆåŠŸä»URLåŠ è½½: ${url}`;
                        } catch (error) {
                            console.error("Failed to load from URL:", error);
                            document.getElementById("error-message").textContent = `ä»URLåŠ è½½å¤±è´¥: ${error}`;
                            document.getElementById("error").style.display = "block";
                        }
                    }
                };

                loadUrlBtn.addEventListener("click", loadFromUrl);
                urlInput.addEventListener("keypress", (event) => {
                    if (event.key === "Enter") {
                        loadFromUrl();
                    }
                });

                // Drag and drop support
                const canvas = document.getElementById("wgpu-canvas");

                canvas.addEventListener("dragover", (event) => {
                    event.preventDefault();
                    canvas.style.backgroundColor = "#333";
                });

                canvas.addEventListener("dragleave", (event) => {
                    event.preventDefault();
                    canvas.style.backgroundColor = "#000";
                });

                canvas.addEventListener("drop", async (event) => {
                    event.preventDefault();
                    canvas.style.backgroundColor = "#000";

                    const files = event.dataTransfer.files;
                    if (files.length > 0) {
                        const file = files[0];
                        if (file.name.toLowerCase().endsWith(".pdb")) {
                            try {
                                console.log("Loading dropped file:", file.name);
                                document.getElementById("status").innerHTML = `æ­£åœ¨åŠ è½½æ‹–æ‹½æ–‡ä»¶: ${file.name}...`;
                                await load_protein_from_file(file);
                                document.getElementById("status").innerHTML = `æˆåŠŸåŠ è½½æ‹–æ‹½æ–‡ä»¶: ${file.name}`;
                            } catch (error) {
                                console.error("Failed to load dropped file:", error);
                                document.getElementById("error-message").textContent = `åŠ è½½æ‹–æ‹½æ–‡ä»¶å¤±è´¥: ${error}`;
                                document.getElementById("error").style.display = "block";
                            }
                        } else {
                            document.getElementById("error-message").textContent = "è¯·æ‹–æ‹½PDBæ–‡ä»¶(.pdb)";
                            document.getElementById("error").style.display = "block";
                        }
                    }
                });
            }

            // Handle canvas resize
            window.addEventListener("resize", () => {
                const canvas = document.getElementById("wgpu-canvas");
                if (canvas) {
                    canvas.width = canvas.offsetWidth;
                    canvas.height = canvas.offsetHeight;
                    console.log("Canvaså°ºå¯¸æ›´æ–°:", canvas.width, "x", canvas.height);
                }
            });

            // Load the viewer when page is ready
            console.log("é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...");
            loadViewer()
                .then(() => {
                    // è‡ªåŠ¨åŠ è½½æµ‹è¯•è›‹ç™½è´¨æ–‡ä»¶
                    setTimeout(async () => {
                        console.log("å°è¯•è‡ªåŠ¨åŠ è½½æµ‹è¯•è›‹ç™½è´¨...");
                        try {
                            if (wasmFunctions && wasmFunctions.load_protein_from_url) {
                                await wasmFunctions.load_protein_from_url("pkg/8w2s.pdb");
                                console.log("æµ‹è¯•è›‹ç™½è´¨åŠ è½½æˆåŠŸ!");
                            } else {
                                console.warn("WASMå‡½æ•°å°šæœªå‡†å¤‡å¥½");
                            }
                        } catch (error) {
                            console.warn("è‡ªåŠ¨åŠ è½½æµ‹è¯•è›‹ç™½è´¨å¤±è´¥:", error);
                        }
                    }, 2000);
                })
                .catch((error) => {
                    console.error("åˆå§‹åŒ–å¤±è´¥:", error);
                });
        </script>
    </body>
</html>
